name: Update Dynamic Tags

# å®šæ—¶ä»»åŠ¡ï¼šæ¯æ—¥ç¾è‚¡æ”¶ç›˜åæ‰§è¡Œï¼ˆUTCæ—¶é—´21:30ï¼Œå¯¹åº”ç¾ä¸œæ—¶é—´16:30æˆ–17:30ï¼‰
on:
  schedule:
    - cron: '30 21 * * 1-5'  # å‘¨ä¸€åˆ°å‘¨äº”æ‰§è¡Œ
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–°æ‰€æœ‰æ ‡ç­¾'
        required: false
        default: 'false'
        type: boolean

env:
  NODE_VERSION: '18'

jobs:
  update-dynamic-tags:
    name: æ›´æ–°åŠ¨æ€æ ‡ç­¾
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: å®‰è£…ä¾èµ–
        run: |
          npm ci
          # å¦‚æœæœ‰ç‰¹å®šçš„è„šæœ¬ä¾èµ–ï¼Œåœ¨è¿™é‡Œå®‰è£…
          npm install pg node-fetch dotenv
          
      - name: éªŒè¯ç¯å¢ƒå˜é‡
        run: |
          echo "æ£€æŸ¥å¿…è¦çš„ç¯å¢ƒå˜é‡..."
          if [ -z "${{ secrets.NEON_DATABASE_URL }}" ]; then
            echo "âŒ NEON_DATABASE_URL æœªè®¾ç½®"
            exit 1
          fi
          if [ -z "${{ secrets.POLYGON_API_KEY }}" ]; then
            echo "âŒ POLYGON_API_KEY æœªè®¾ç½®"
            exit 1
          fi
          echo "âœ… ç¯å¢ƒå˜é‡éªŒè¯é€šè¿‡"
          
      - name: æ‰§è¡Œæ ‡ç­¾æ›´æ–°
        env:
          NEON_DATABASE_URL: ${{ secrets.NEON_DATABASE_URL }}
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
          NODE_ENV: production
          FORCE_UPDATE: ${{ github.event.inputs.force_update }}
        run: |
          echo "ğŸš€ å¼€å§‹æ‰§è¡ŒåŠ¨æ€æ ‡ç­¾æ›´æ–°..."
          echo "æ‰§è¡Œæ—¶é—´: $(date -u)"
          echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          
          # æ‰§è¡Œæ ‡ç­¾æ›´æ–°è„šæœ¬
          node scripts/update-dynamic-tags.js
          
          echo "âœ… æ ‡ç­¾æ›´æ–°å®Œæˆ"
          
      - name: é€šçŸ¥ç»“æœ
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "ğŸ‰ åŠ¨æ€æ ‡ç­¾æ›´æ–°æˆåŠŸå®Œæˆ"
            echo "æ—¶é—´: $(date -u)"
            echo "å·¥ä½œæµ: ${{ github.workflow }}"
            echo "è¿è¡ŒID: ${{ github.run_id }}"
          else
            echo "âŒ åŠ¨æ€æ ‡ç­¾æ›´æ–°å¤±è´¥"
            echo "è¯·æ£€æŸ¥æ—¥å¿—ä»¥è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯"
          fi
          
      # å¯é€‰ï¼šå‘é€é€šçŸ¥åˆ°Slack/Discordç­‰
      # - name: å‘é€é€šçŸ¥
      #   if: failure()
      #   uses: 8398a7/action-slack@v3
      #   with:
      #     status: ${{ job.status }}
      #     text: 'åŠ¨æ€æ ‡ç­¾æ›´æ–°å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—'
      #   env:
      #     SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # å¯é€‰ï¼šå¥åº·æ£€æŸ¥ä»»åŠ¡
  health-check:
    name: æ ‡ç­¾ç³»ç»Ÿå¥åº·æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: update-dynamic-tags
    if: success()
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: éªŒè¯æ ‡ç­¾æ•°æ®
        env:
          NEON_DATABASE_URL: ${{ secrets.NEON_DATABASE_URL }}
        run: |
          echo "ğŸ” æ‰§è¡Œæ ‡ç­¾ç³»ç»Ÿå¥åº·æ£€æŸ¥..."
          
          # è¿™é‡Œå¯ä»¥æ·»åŠ ä¸€äº›åŸºæœ¬çš„æ•°æ®éªŒè¯è„šæœ¬
          # ä¾‹å¦‚ï¼šæ£€æŸ¥æ ‡ç­¾æ•°é‡ã€éªŒè¯æ•°æ®å®Œæ•´æ€§ç­‰
          
          echo "âœ… å¥åº·æ£€æŸ¥å®Œæˆ"