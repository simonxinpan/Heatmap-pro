name: Update Heatmap Data

on:
  schedule:
    # æ¯5åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ (CRONè¯­æ³•: åˆ† æ—¶ æ—¥ æœˆ å‘¨)
    - cron: '*/5 * * * *'
  # å…è®¸æ‰‹åŠ¨è§¦å‘ï¼Œæ–¹ä¾¿æµ‹è¯•
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Call data refresh API
        run: |
          echo "ğŸ”„ è§¦å‘çƒ­åŠ›å›¾æ•°æ®åˆ·æ–°..."
          response=$(curl -X GET "https://heatmap-pro.vercel.app/api/refresh-data" \
            -H "User-Agent: GitHub-Actions-Heatmap-Updater" \
            -H "Accept: application/json" \
            --silent --show-error --write-out "HTTPSTATUS:%{http_code}")
          
          http_code=$(echo $response | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
          body=$(echo $response | sed -e 's/HTTPSTATUS:.*//g')
          
          echo "ğŸ“Š APIå“åº”çŠ¶æ€: $http_code"
          echo "ğŸ“‹ å“åº”å†…å®¹: $body"
          
          if [ $http_code -eq 200 ]; then
            echo "âœ… æ•°æ®åˆ·æ–°æˆåŠŸ"
          else
            echo "âŒ æ•°æ®åˆ·æ–°å¤±è´¥ï¼ŒçŠ¶æ€ç : $http_code"
            exit 1
          fi
          
      - name: Refresh cache
        run: |
          echo "ğŸ”„ åˆ·æ–°è‚¡ç¥¨APIç¼“å­˜..."
          curl -X GET "https://heatmap-pro.vercel.app/api/stocks?refresh=true" \
            -H "User-Agent: GitHub-Actions" \
            -H "Accept: application/json" \
            --silent --show-error
          echo "ğŸ’¾ ç¼“å­˜åˆ·æ–°å®Œæˆ"
          
      - name: Notify completion
        run: |
          echo "âœ… çƒ­åŠ›å›¾æ•°æ®æ›´æ–°ä»»åŠ¡å®Œæˆ"
          echo "ğŸ“Š è‚¡ç¥¨æ•°æ®å·²æ›´æ–°"
          echo "ğŸ”„ Vercelç¼“å­˜å·²åˆ·æ–°"
          echo "â° ä¸‹æ¬¡æ›´æ–°æ—¶é—´: $(date -d '+5 minutes' '+%Y-%m-%d %H:%M:%S')"