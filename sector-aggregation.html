<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡Œä¸šèšåˆçƒ­åŠ›å›¾</title>
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/sector-aggregation.css">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
</head>
<body class="bg-gray-900 text-white">
    <div class="container mx-auto p-4">
        <header class="text-center my-8">
            <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-teal-300">
                è¡Œä¸šæ¿å—èšåˆè§†å›¾
            </h1>
            <p class="text-lg text-gray-400 mt-2">
                å„å¤§è¡Œä¸šå¸‚å€¼ä¸æ¶¨è·Œå¹…æ¦‚è§ˆ
            </p>
        </header>

        <main id="aggregation-container" class="space-y-12">
            <!-- è¡Œä¸šçƒ­åŠ›å›¾å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const sectors = [
                { name: 'ä¿¡æ¯æŠ€æœ¯', code: 'ä¿¡æ¯æŠ€æœ¯', icon: 'ğŸ’»' },
                { name: 'å·¥ä¸š', code: 'å·¥ä¸š', icon: 'ğŸ­' },
                { name: 'é‡‘è', code: 'é‡‘è', icon: 'ğŸ¦' },
                { name: 'åŒ»ç–—ä¿å¥', code: 'åŒ»ç–—ä¿å¥', icon: 'ğŸ¥' },
                { name: 'éå¿…éœ€æ¶ˆè´¹å“', code: 'éå¿…éœ€æ¶ˆè´¹å“', icon: 'ğŸ›ï¸' },
                { name: 'æ—¥å¸¸æ¶ˆè´¹å“', code: 'æ—¥å¸¸æ¶ˆè´¹å“', icon: 'ğŸ›’' },
                { name: 'å…¬ç”¨äº‹ä¸š', code: 'å…¬ç”¨äº‹ä¸š', icon: 'âš¡' },
                { name: 'æˆ¿åœ°äº§', code: 'æˆ¿åœ°äº§', icon: 'ğŸ ' },
                { name: 'åŸææ–™', code: 'åŸææ–™', icon: 'â›ï¸' },
                { name: 'èƒ½æº', code: 'èƒ½æº', icon: 'â›½' },
                { name: 'åŠå¯¼ä½“', code: 'åŠå¯¼ä½“', icon: 'ğŸ”Œ' },
                { name: 'åª’ä½“å¨±ä¹', code: 'åª’ä½“å¨±ä¹', icon: 'ğŸ¬' },
                { name: 'é€šè®¯æœåŠ¡', code: 'é€šè®¯æœåŠ¡', icon: 'ğŸ“¡' }
            ];

            const container = document.getElementById('aggregation-container');
            if (!container) return;

            sectors.forEach(sector => {
                const sectorElement = document.createElement('div');
                sectorElement.className = 'sector-treemap';
                
                const titleElement = document.createElement('h2');
                titleElement.className = 'sector-title';
                titleElement.innerHTML = `<span class="sector-icon">${sector.icon}</span> ${sector.name}`;
                
                const chartId = `treemap-${sector.code.replace(/\s+/g, '-')}`;
                const chartContainer = document.createElement('div');
                chartContainer.id = chartId;
                chartContainer.className = 'treemap-chart';

                sectorElement.appendChild(titleElement);
                sectorElement.appendChild(chartContainer);
                container.appendChild(sectorElement);

                // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                const mockData = generateMockData(sector.name, 20);
                initTreemap(chartId, mockData, sector.name);
            });
        });

        function generateMockData(sectorName, count) {
            const data = [];
            const symbols = ['AAPL', 'MSFT', 'GOOG', 'AMZN', 'TSLA', 'NVDA', 'META', 'JPM', 'V', 'JNJ'];
            for (let i = 0; i < count; i++) {
                data.push({
                    name: `${symbols[i % symbols.length]}${i > 9 ? i : ''}`,
                    value: Math.random() * 1000 + 100, // å¸‚å€¼
                    change: (Math.random() - 0.5) * 10, // æ¶¨è·Œå¹…
                    symbol: `${symbols[i % symbols.length]}${i > 9 ? i : ''}`
                });
            }
            return data;
        }

        function initTreemap(containerId, data, sectorName) {
            const chartDom = document.getElementById(containerId);
            if (!chartDom) return;
            const myChart = echarts.init(chartDom);

            const option = {
                tooltip: {
                    formatter: function (info) {
                        const { name, value, change, symbol } = info.data;
                        const sign = change >= 0 ? '+' : '';
                        const color = change >= 0 ? '#10B981' : '#EF4444';
                        return `
                            <div style="font-family: sans-serif; font-size: 14px; background: #fff; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); padding: 8px 12px; border: 1px solid #eee;">
                                <strong style="font-size: 16px;">${symbol}</strong><br>
                                å¸‚å€¼: ${(value / 10).toFixed(2)}B<br>
                                æ¶¨è·Œ: <span style="color: ${color}; font-weight: 600;">${sign}${change.toFixed(2)}%</span>
                            </div>
                        `;
                    },
                    backgroundColor: 'transparent',
                    borderWidth: 0,
                    padding: 0
                },
                series: [{
                    type: 'treemap',
                    data: data,
                    leafDepth: 1,
                    label: {
                        show: true,
                        formatter: '{b}',
                        fontSize: 14,
                        fontWeight: 'bold',
                        color: '#fff'
                    },
                    itemStyle: {
                        borderColor: '#fff',
                        borderWidth: 1,
                        gapWidth: 1,
                        color: function(params) {
                            const change = params.data.change;
                            if (change >= 0) {
                                return `rgba(16, 185, 129, ${0.3 + (change / 10) * 0.7})`;
                            } else {
                                return `rgba(239, 68, 68, ${0.3 + (Math.abs(change) / 10) * 0.7})`;
                            }
                        }
                    },
                    emphasis: {
                        label: {
                            color: '#000'
                        },
                        itemStyle: {
                            borderColor: '#3B82F6',
                            borderWidth: 2
                        }
                    },
                    breadcrumb: {
                        show: false
                    }
                }]
            };

            myChart.setOption(option);
            
            /**
             * ==================================================================
             * === âœ¨ å”¯ä¸€çš„ã€å†³å®šæ€§çš„ä¿®æ”¹ç‚¹ (æœ€ç»ˆç‰ˆ) âœ¨ ===
             * === ä¸‹é¢çš„ click äº‹ä»¶å¤„ç†å‡½æ•°ä½¿ç”¨ window.top å¼ºåˆ¶åœ¨æœ€é¡¶å±‚çª—å£è·³è½¬ ===
             * ==================================================================
             */
            myChart.on('click', function(params) {
                // ç¡®ä¿ç‚¹å‡»çš„æ˜¯æœ‰æ•ˆçš„è‚¡ç¥¨æ–¹å—
                if (params.data && params.data.symbol) {
                    const symbol = params.data.symbol;
            
                    // --- è¿™æ˜¯æœ€å…³é”®çš„æ™ºèƒ½åˆ¤æ–­ ---
            
                    // 1. è¯»å–å½“å‰çƒ­åŠ›å›¾é¡µé¢çš„URLå‚æ•° (å³æ­¤ iframe çš„ src)
                    const urlParams = new URLSearchParams(window.location.search);
                    
                    // 2. æ£€æŸ¥URLä¸­æ˜¯å¦å­˜åœ¨ "layout=vertical" è¿™ä¸ªæˆ‘ä»¬ä¸ºç§»åŠ¨ç«¯è®¾ç½®çš„å‚æ•°
                    const isMobileContext = urlParams.get('layout') === 'vertical';
            
                    // 3. æ ¹æ®åˆ¤æ–­ç»“æœï¼Œé€‰æ‹©ä¸åŒçš„åŸºç¡€URL
                    let baseUrl;
                    if (isMobileContext) {
                        // å¦‚æœæ˜¯ç§»åŠ¨ç«¯ç¯å¢ƒï¼Œå°±ä½¿ç”¨ç§»åŠ¨ç‰ˆè¯¦æƒ…é¡µçš„URL
                        console.log("[æ™ºèƒ½è·³è½¬] æ£€æµ‹åˆ°ç§»åŠ¨ç«¯ç¯å¢ƒ (layout=vertical)ï¼Œå°†è·³è½¬åˆ°ç§»åŠ¨ç‰ˆè¯¦æƒ…é¡µã€‚");
                        baseUrl = 'https://stock-details-final.vercel.app/mobile.html';
                    } else {
                        // å¦åˆ™ï¼Œä½¿ç”¨é»˜è®¤çš„æ¡Œé¢ç‰ˆè¯¦æƒ…é¡µURLï¼Œä¿æŒæ¡Œé¢ç‰ˆä½“éªŒä¸å˜
                        console.log("[æ™ºèƒ½è·³è½¬] æœªæ£€æµ‹åˆ°ç§»åŠ¨ç«¯ç¯å¢ƒï¼Œå°†è·³è½¬åˆ°æ¡Œé¢ç‰ˆè¯¦æƒ…é¡µã€‚");
                        baseUrl = 'https://stock-details-final.vercel.app/';
                    }
            
                    // 4. æ„é€ æœ€ç»ˆçš„è·³è½¬é“¾æ¥
                    const finalUrl = `${baseUrl}?symbol=${symbol}`;
            
                    // 5. ä½¿ç”¨ window.top ç›´æ¥å‘½ä»¤æµè§ˆå™¨æœ€é¡¶å±‚çª—å£è¿›è¡Œè·³è½¬
                    //    è¿™æ˜¯ç©¿é€ iframe çš„æœ€å¯é æ–¹æ³•
                    if (window.top) {
                        console.log(`[Top Level Navigation] æ­£åœ¨å‘½ä»¤é¡¶å±‚çª—å£è·³è½¬åˆ°: ${finalUrl}`);
                        window.top.location.href = finalUrl;
                    } else {
                        // å¦‚æœç”±äºæŸç§æç«¯æƒ…å†µæ— æ³•è®¿é—® topï¼Œåˆ™ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆåœ¨å½“å‰çª—å£è·³è½¬
                        console.log(`[Fallback Navigation] æ— æ³•è®¿é—®é¡¶å±‚çª—å£ï¼Œåœ¨å½“å‰çª—å£è·³è½¬: ${finalUrl}`);
                        window.location.href = finalUrl;
                    }
                } else {
                     console.log("ç‚¹å‡»çš„ä¸æ˜¯æœ‰æ•ˆçš„è‚¡ç¥¨æ–¹å—ï¼Œä¸æ‰§è¡Œè·³è½¬ã€‚");
                }
            });
        }
    </script>
</body>
</html>