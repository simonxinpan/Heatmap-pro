<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>行业聚合热力图</title>
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/sector-aggregation.css">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
</head>
<body class="bg-gray-900 text-white">
    <div class="container mx-auto p-4">
        <header class="text-center my-8">
            <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-teal-300">
                行业板块聚合视图
            </h1>
            <p class="text-lg text-gray-400 mt-2">
                各大行业市值与涨跌幅概览
            </p>
        </header>

        <main id="aggregation-container" class="space-y-12">
            <!-- 行业热力图将由JS动态生成 -->
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const sectors = [
                { name: '信息技术', code: '信息技术', icon: '💻' },
                { name: '工业', code: '工业', icon: '🏭' },
                { name: '金融', code: '金融', icon: '🏦' },
                { name: '医疗保健', code: '医疗保健', icon: '🏥' },
                { name: '非必需消费品', code: '非必需消费品', icon: '🛍️' },
                { name: '日常消费品', code: '日常消费品', icon: '🛒' },
                { name: '公用事业', code: '公用事业', icon: '⚡' },
                { name: '房地产', code: '房地产', icon: '🏠' },
                { name: '原材料', code: '原材料', icon: '⛏️' },
                { name: '能源', code: '能源', icon: '⛽' },
                { name: '半导体', code: '半导体', icon: '🔌' },
                { name: '媒体娱乐', code: '媒体娱乐', icon: '🎬' },
                { name: '通讯服务', code: '通讯服务', icon: '📡' }
            ];

            const container = document.getElementById('aggregation-container');
            if (!container) return;

            sectors.forEach(sector => {
                const sectorElement = document.createElement('div');
                sectorElement.className = 'sector-treemap';
                
                const titleElement = document.createElement('h2');
                titleElement.className = 'sector-title';
                titleElement.innerHTML = `<span class="sector-icon">${sector.icon}</span> ${sector.name}`;
                
                const chartId = `treemap-${sector.code.replace(/\s+/g, '-')}`;
                const chartContainer = document.createElement('div');
                chartContainer.id = chartId;
                chartContainer.className = 'treemap-chart';

                sectorElement.appendChild(titleElement);
                sectorElement.appendChild(chartContainer);
                container.appendChild(sectorElement);

                // 使用模拟数据
                const mockData = generateMockData(sector.name, 20);
                initTreemap(chartId, mockData, sector.name);
            });
        });

        function generateMockData(sectorName, count) {
            const data = [];
            const symbols = ['AAPL', 'MSFT', 'GOOG', 'AMZN', 'TSLA', 'NVDA', 'META', 'JPM', 'V', 'JNJ'];
            for (let i = 0; i < count; i++) {
                data.push({
                    name: `${symbols[i % symbols.length]}${i > 9 ? i : ''}`,
                    value: Math.random() * 1000 + 100, // 市值
                    change: (Math.random() - 0.5) * 10, // 涨跌幅
                    symbol: `${symbols[i % symbols.length]}${i > 9 ? i : ''}`
                });
            }
            return data;
        }

        function initTreemap(containerId, data, sectorName) {
            const chartDom = document.getElementById(containerId);
            if (!chartDom) return;
            const myChart = echarts.init(chartDom);

            const option = {
                tooltip: {
                    formatter: function (info) {
                        const { name, value, change, symbol } = info.data;
                        const sign = change >= 0 ? '+' : '';
                        const color = change >= 0 ? '#10B981' : '#EF4444';
                        return `
                            <div style="font-family: sans-serif; font-size: 14px; background: #fff; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); padding: 8px 12px; border: 1px solid #eee;">
                                <strong style="font-size: 16px;">${symbol}</strong><br>
                                市值: ${(value / 10).toFixed(2)}B<br>
                                涨跌: <span style="color: ${color}; font-weight: 600;">${sign}${change.toFixed(2)}%</span>
                            </div>
                        `;
                    },
                    backgroundColor: 'transparent',
                    borderWidth: 0,
                    padding: 0
                },
                series: [{
                    type: 'treemap',
                    data: data,
                    leafDepth: 1,
                    label: {
                        show: true,
                        formatter: '{b}',
                        fontSize: 14,
                        fontWeight: 'bold',
                        color: '#fff'
                    },
                    itemStyle: {
                        borderColor: '#fff',
                        borderWidth: 1,
                        gapWidth: 1,
                        color: function(params) {
                            const change = params.data.change;
                            if (change >= 0) {
                                return `rgba(16, 185, 129, ${0.3 + (change / 10) * 0.7})`;
                            } else {
                                return `rgba(239, 68, 68, ${0.3 + (Math.abs(change) / 10) * 0.7})`;
                            }
                        }
                    },
                    emphasis: {
                        label: {
                            color: '#000'
                        },
                        itemStyle: {
                            borderColor: '#3B82F6',
                            borderWidth: 2
                        }
                    },
                    breadcrumb: {
                        show: false
                    }
                }]
            };

            myChart.setOption(option);
            
            /**
             * ==================================================================
             * === ✨ 唯一的、决定性的修改点 (最终版) ✨ ===
             * === 下面的 click 事件处理函数使用 window.top 强制在最顶层窗口跳转 ===
             * ==================================================================
             */
            myChart.on('click', function(params) {
                // 确保点击的是有效的股票方块
                if (params.data && params.data.symbol) {
                    const symbol = params.data.symbol;
            
                    // --- 这是最关键的智能判断 ---
            
                    // 1. 读取当前热力图页面的URL参数 (即此 iframe 的 src)
                    const urlParams = new URLSearchParams(window.location.search);
                    
                    // 2. 检查URL中是否存在 "layout=vertical" 这个我们为移动端设置的参数
                    const isMobileContext = urlParams.get('layout') === 'vertical';
            
                    // 3. 根据判断结果，选择不同的基础URL
                    let baseUrl;
                    if (isMobileContext) {
                        // 如果是移动端环境，就使用移动版详情页的URL
                        console.log("[智能跳转] 检测到移动端环境 (layout=vertical)，将跳转到移动版详情页。");
                        baseUrl = 'https://stock-details-final.vercel.app/mobile.html';
                    } else {
                        // 否则，使用默认的桌面版详情页URL，保持桌面版体验不变
                        console.log("[智能跳转] 未检测到移动端环境，将跳转到桌面版详情页。");
                        baseUrl = 'https://stock-details-final.vercel.app/';
                    }
            
                    // 4. 构造最终的跳转链接
                    const finalUrl = `${baseUrl}?symbol=${symbol}`;
            
                    // 5. 使用 window.top 直接命令浏览器最顶层窗口进行跳转
                    //    这是穿透 iframe 的最可靠方法
                    if (window.top) {
                        console.log(`[Top Level Navigation] 正在命令顶层窗口跳转到: ${finalUrl}`);
                        window.top.location.href = finalUrl;
                    } else {
                        // 如果由于某种极端情况无法访问 top，则作为备用方案在当前窗口跳转
                        console.log(`[Fallback Navigation] 无法访问顶层窗口，在当前窗口跳转: ${finalUrl}`);
                        window.location.href = finalUrl;
                    }
                } else {
                     console.log("点击的不是有效的股票方块，不执行跳转。");
                }
            });
        }
    </script>
</body>
</html>