<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S&P 500 Heatmap - Live</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@2.3.0/dist/chartjs-chart-treemap.min.js"></script>
    <style> [x-cloak] { display: none !important; } </style>
</head>
<body class="bg-gray-900 text-white" x-data="heatmapApp()" x-init="init()">

    <header class="p-4 text-center">
        <h1 class="text-3xl font-bold">S&P 500 市场热力图</h1>
        <p class="text-sm text-gray-400" x-text="lastUpdated"></p>
    </header>

    <main class="container mx-auto p-4">
        <div x-show="loading" class="text-center text-2xl animate-pulse">正在加载市场数据...</div>
        <div x-show="error" class="bg-red-500 text-white p-4 rounded-lg" x-text="error"></div>
        
        <!-- *** 关键：用一个简单的 canvas 替换所有复杂的 template *** -->
        <div x-show="!loading && !error" class="w-full h-[80vh]" x-cloak>
            <canvas id="heatmapChart"></canvas>
        </div>
    </main>

    <script>
        function heatmapApp() {
            return {
                stocks: [],
                loading: true,
                error: null,
                lastUpdated: '最后更新: 载入中...',
                chart: null,

                async init() {
                    await this.loadHeatmapData();
                    setInterval(() => this.loadHeatmapData(false), 300000); // 5分钟刷新
                },

                async loadHeatmapData(isInitialLoad = true) {
                    if (isInitialLoad) this.loading = true;
                    this.error = null;
                    try {
                        const response = await fetch('/api/stocks');
                        if (!response.ok) throw new Error(`API responded with status ${response.status}`);
                        this.stocks = await response.json();
                        this.lastUpdated = `最后更新: ${new Date().toLocaleTimeString()}`;
                        this.renderTreemap(); // 调用新的渲染函数
                    } catch (error) {
                        this.error = `错误: ${error.message}`;
                    } finally {
                        if (isInitialLoad) this.loading = false;
                    }
                },
                
                // *** 核心：使用 Treemap 插件进行高性能渲染 ***
                renderTreemap() {
                    if (this.chart) {
                        this.chart.destroy();
                    }
                    const ctx = document.getElementById('heatmapChart');
                    if (!ctx || this.stocks.length === 0) return;

                    const data = this.stocks.map(stock => ({
                        // Treemap 需要知道每个方块的“价值”（决定面积）和它的“颜色值”
                        v: Math.abs(stock.quote.dp || 0), // 用涨跌幅绝对值作为面积权重
                        c: stock.quote.dp || 0, // 用涨跌幅作为颜色值
                        s: stock.sector_zh, // 用于分组
                        data: stock // 把原始股票数据挂载上去，方便后面使用
                    }));

                    this.chart = new Chart(ctx, {
                        type: 'treemap',
                        data: {
                            datasets: [{
                                tree: data,
                                key: 'v', // 面积由 v 决定
                                groups: ['s'], // 按板块 s 分组
                                backgroundColor: (c) => {
                                    const value = c.raw.c; // 获取颜色值 dp
                                    if (value > 0) return `rgba(16, 185, 129, ${0.4 + (Math.min(value, 3) / 3) * 0.6})`;
                                    if (value < 0) return `rgba(239, 68, 68, ${0.4 + (Math.abs(Math.max(value, -3)) / 3) * 0.6})`;
                                    return '#4B5563';
                                },
                                borderColor: 'rgba(255, 255, 255, 0.2)',
                                borderWidth: 1,
                                labels: {
                                    display: true,
                                    color: 'white',
                                    font: { size: 12, weight: 'bold' },
                                    formatter(c) {
                                        // 在方块上显示股票代码
                                        return c.raw.data.ticker;
                                    }
                                }
                            }]
                        },
                        options: {
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        title: (c) => c[0].raw.data.name_zh,
                                        label: (c) => `${(c.raw.c > 0 ? '+' : '')}${c.raw.c.toFixed(2)}%`
                                    }
                                }
                            },
                            // 点击方块时，跳转到详情页
                            onClick: (e, elements) => {
                                if (elements.length > 0) {
                                    const stockData = elements[0].element.$context.raw.data;
                                    window.open(`https://stock-details-final.vercel.app/?symbol=${stockData.ticker}`, '_blank');
                                }
                            }
                        }
                    });
                }
            }
        }
    </script>
</body>
</html>